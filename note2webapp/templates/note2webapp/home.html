{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}
{% block title %}Note2Web{% endblock %}

{% block content %}

{% if page == "list" %}
<div class="model-shell">
  <div class="model-head">
    <div class="model-head-left">
      <div class="model-head-icon">üìÇ</div>
      <div>
        <div class="model-head-title">Your Model Uploads</div>
        <div class="model-head-sub">Manage your registered models and their validated versions.</div>
      </div>
    </div>
    <div class="model-head-right">
      <!-- Tutorial button with refined styling -->
      <button
        type="button"
        class="tutorial-btn"
        data-bs-toggle="modal"
        data-bs-target="#uploaderTutorialModal">
        <span class="tutorial-icon">?</span>
        <span class="tutorial-label">Tutorial</span>
      </button>

      <a href="?page=create" class="new-upload-primary-btn">+ New Upload</a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  {% for upload in uploads %}
    <div class="upload-row">
      <div class="upload-main">
        <div class="upload-name" title="{{ upload.name }}">{{ upload.name }}</div>
        <div class="upload-meta">
          Validated Versions: {{ upload.active_versions_count|default:"0" }}
        </div>
      </div>
      <div class="upload-actions">
        <a href="?page=detail&pk={{ upload.pk }}" class="row-action-btn open-btn">Open</a>

        <button class="row-action-btn delete-btn delete-model-btn"
                data-model-id="{{ upload.id }}"
                data-model-name="{{ upload.name }}"
                data-version-count="{{ upload.active_versions_count|default:0 }}">
          Delete
        </button>
      </div>
    </div>
  {% empty %}
    <div class="empty-state">
      <div class="empty-emoji">üì≠</div>
      <div class="empty-title">No uploads yet</div>
      <div class="empty-desc">Start by creating a model container, then add a version.</div>
      <a href="?page=create" class="new-upload-primary-btn empty-cta-btn">+ New Upload</a>
    </div>
  {% endfor %}

</div>

<!-- Uploader Tutorial Modal -->
<div class="modal fade" id="uploaderTutorialModal" tabindex="-1"
     aria-labelledby="uploaderTutorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background-color:#111827; color:#e5e7eb;">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="uploaderTutorialLabel">Uploader Tutorial</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="ratio ratio-16x9">
          <video controls>
            <!-- Put your actual video file at: note2webapp/static/note2webapp/videos/uploader_tutorial.mp4 -->
            <source src="{% static 'note2webapp/videos/uploader_tutorial.mp4' %}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* ---------- SHARED LOOK & FEEL ---------- */
.model-shell,
.create-shell,
.detail-shell,
.version-shell {
  max-width: 900px;
  background-color: #1b1d22;
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 16px;
  padding: 24px;
  margin: 0 auto;
  box-shadow: 0 32px 64px rgba(0,0,0,0.8);
  color: #fff;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* blue CTA pill */
.new-upload-primary-btn {
  display: inline-block;
  background: radial-gradient(circle at 20% 20%, #4a6bff 0%, #1d3bd1 60%);
  box-shadow: 0 20px 40px rgba(35,76,228,0.4);
  color: #fff;
  font-weight: 600;
  font-size: 0.9rem;
  padding: 10px 14px;
  line-height: 1.2;
  border-radius: 10px;
  text-decoration: none;
  border: 0;
  white-space: nowrap;
}
.new-upload-primary-btn:hover {
  filter: brightness(1.07);
  color: #fff;
  text-decoration: none;
}

/* Tutorial button ‚Äì secondary pill */
.tutorial-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.7);
  background: radial-gradient(circle at 0% 0%, #020617 0%, #111827 70%);
  box-shadow: 0 0 0 1px rgba(15,23,42,0.9);
  font-size: 0.8rem;
  font-weight: 500;
  color: #e5e7eb;
  cursor: pointer;
  margin-right: 10px;
  transition:
    background-color 0.15s ease,
    border-color 0.15s ease,
    box-shadow 0.15s ease,
    transform 0.15s ease;
}
.tutorial-btn:hover {
  border-color: rgba(129,140,248,0.9);
  box-shadow: 0 6px 14px rgba(15,23,42,0.9);
  transform: translateY(-1px);
}
.tutorial-icon {
  width: 18px;
  height: 18px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
  background: rgba(15,23,42,1);
  color: #a5b4fc; /* soft indigo */
  box-shadow: inset 0 0 0 1px rgba(148,163,184,0.7);
}
.tutorial-label {
  line-height: 1;
}

/* neutral pill ("soft button") */
.soft-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background-color: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px;
  padding: 10px 14px;
  font-size: 0.9rem;
  font-weight: 500;
  color: #fff;
  line-height: 1.2;
  text-decoration: none;
  cursor: pointer;
  white-space: nowrap;
}
.soft-btn:hover {
  background-color: rgba(255,255,255,0.1);
  text-decoration: none;
  color: #fff;
}

/* header block for list screen */
.model-head {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  row-gap: 12px;
  column-gap: 16px;
  margin-bottom: 24px;
}
.model-head-left {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  min-width: 0;
}
.model-head-icon {
  font-size: 1.4rem;
  line-height: 1.2;
}
.model-head-title {
  font-size: 1rem;
  font-weight: 600;
  color: #fff;
  line-height: 1.4;
}
.model-head-sub {
  font-size: 0.85rem;
  color: #8f96a3;
  line-height: 1.4;
  margin-top: 2px;
}
.model-head-right {
  flex-shrink: 0;
}

/* list rows */
.upload-row {
  background-color: #24272d;
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 12px;
  box-shadow: 0 24px 48px rgba(0,0,0,0.7);
  padding: 16px 20px;
  margin-bottom: 16px;

  display: flex;
  flex-wrap: wrap;
  row-gap: 12px;
  column-gap: 16px;
  justify-content: space-between;
  align-items: flex-start;
}
.upload-main { min-width: 0; }
.upload-name {
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
  line-height: 1.4;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.upload-meta {
  color: #9ca3af;
  font-size: 0.8rem;
  line-height: 1.4;
  margin-top: 4px;
}

.upload-actions {
  flex-shrink: 0;
  display: flex;
  gap: 8px;
}
.row-action-btn {
  border-radius: 8px;
  font-size: 0.8rem;
  font-weight: 500;
  line-height: 1.2;
  padding: 8px 12px;
  min-width: 70px;
  text-align: center;
  text-decoration: none;
  border: 1px solid transparent;
  cursor: pointer;
  white-space: nowrap;
}
.open-btn {
  background: rgba(80,130,255,0.12);
  border: 1px solid rgba(80,130,255,0.5);
  color: #fff;
}
.open-btn:hover {
  background: rgba(80,130,255,0.2);
}
.delete-btn {
  background: rgba(255,0,0,0.08);
  border: 1px solid rgba(255,0,0,0.4);
  color: #fff;
}
.delete-btn:hover {
  background: rgba(255,0,0,0.14);
}

/* empty state for list page */
.empty-state {
  background: rgba(255,255,255,0.02);
  border: 1px dashed rgba(255,255,255,0.15);
  border-radius: 12px;
  text-align: center;
  padding: 40px 20px;
  margin-top: 16px;
  box-shadow: 0 24px 48px rgba(0,0,0,0.6);
}
.empty-emoji {
  font-size: 2rem;
  line-height: 1;
  margin-bottom: 12px;
}
.empty-title {
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 4px;
}
.empty-desc {
  color: #8f96a3;
  font-size: 0.85rem;
  margin-bottom: 16px;
}
.empty-cta-btn {
  font-size: 0.85rem;
  padding: 9px 12px;
}
</style>

<script>
document.querySelectorAll('.delete-model-btn').forEach(button => {
  button.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();

    const modelId = this.dataset.modelId;
    const modelName = this.dataset.modelName;
    const versionCount = parseInt(this.dataset.versionCount) || 0;

    if (versionCount > 0) {
      alert('‚ùå Cannot delete model with ' + versionCount + ' active versions. Please delete all versions first.');
      return;
    }

    if (confirm(`‚ö†Ô∏è Permanently delete "${modelName}"?\nThis cannot be undone.`)) {
      fetch(`/delete-model/${modelId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('‚úÖ ' + data.message);
          location.reload();
        } else {
          alert('‚ùå Error: ' + data.error);
        }
      })
      .catch(error => {
        alert('‚ùå Error deleting model. Please try again.');
        console.error('Error:', error);
      });
    }
  });
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

{% elif page == "create" %}
<div class="create-shell">

  <!-- header -->
  <div class="create-head">
    <div class="create-head-title">Create New Upload</div>
    <div class="create-head-sub">Give your model container a name.</div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <form method="post" class="create-form">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label create-label">Upload Name</label>
      {{ form.name|add_class:"form-control create-input" }}
      {% if form.name.errors %}
        <div class="text-danger mt-1">{{ form.name.errors }}</div>
      {% endif %}
    </div>

    <div class="create-actions">
      <a href="?page=list" class="create-back-btn">
        <span>‚Üê</span>
        <span>Back</span>
      </a>
      <button type="submit" class="create-submit-btn">
        Create
      </button>
    </div>
  </form>
</div>

<style>
.create-shell {
  max-width: 900px;
  background-color: #1b1d22;
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 16px;
  padding: 24px;
  margin: 0 auto;
  box-shadow: 0 32px 64px rgba(0,0,0,0.8);
  color: #fff;
  font-family: system-ui,-apple-system,BlinkMacSystemFont,"Inter",Roboto,"Helvetica Neue",Arial,sans-serif;
}

.create-head {
  margin-bottom:20px;
}
.create-head-title {
  font-size:1.2rem;
  font-weight:600;
  color:#fff;
  line-height:1.4;
  margin-bottom: 4px;
}
.create-head-sub {
  font-size:0.9rem;
  line-height:1.4;
  color:#8f96a3;
}

.create-label {
  font-weight:500;
  font-size:0.9rem;
  color:#fff;
  margin-bottom:6px;
}
.create-input {
  background-color:#1b1d22 !important;
  color:#fff !important;
  border:1px solid rgba(255,255,255,0.18) !important;
  font-size:0.9rem;
  border-radius:8px;
  line-height:1.4;
  padding:10px 12px;
}
.create-input:focus {
  outline:2px solid rgba(80,130,255,0.6);
  outline-offset:0;
  box-shadow:0 0 0 4px rgba(80,130,255,0.15);
  border-color:rgba(80,130,255,0.8) !important;
}

.create-actions {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:24px;
}

/* Back button - gray */
.create-back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background-color: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 0.9rem;
  font-weight: 500;
  color: #fff;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;
}
.create-back-btn:hover {
  background-color: rgba(255,255,255,0.1);
  text-decoration: none;
  color: #fff;
}

/* Create button - blue */
.create-submit-btn {
  display: inline-flex;
  align-items: center;
  background: radial-gradient(circle at 20% 20%, #4a6bff 0%, #1d3bd1 60%);
  box-shadow: 0 4px 12px rgba(35,76,228,0.4);
  color: #fff;
  font-weight: 600;
  font-size: 0.9rem;
  padding: 10px 18px;
  border-radius: 10px;
  border: 0;
  cursor: pointer;
  transition: all 0.2s ease;
}
.create-submit-btn:hover {
  filter: brightness(1.1);
  color: #fff;
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(35,76,228,0.5);
}
</style>


{% elif page == "detail" %}
<div class="detail-shell">

  <!-- Top bar with back button -->
  <div class="detail-top-bar">
    <a href="?page=list" class="detail-back-btn">
      <span>‚Üê</span>
      <span>Back to Models</span>
    </a>
  </div>

  <div class="detail-header">
    <div class="detail-title-section">
      <div class="detail-model-name">{{ upload.name }}</div>
      <div class="detail-model-meta">
        {{ versions|length }} version{% if versions|length != 1 %}s{% endif %} total
      </div>
    </div>

    <div class="detail-action-buttons">
      <a href="{% url 'model_versions' upload.id %}" class="detail-manage-btn">
        <span>‚öôÔ∏è</span>
        <span>Manage Versions</span>
      </a>
      <a href="?page=add_version&pk={{ upload.pk }}" class="detail-new-version-btn">
        + New Version
      </a>
    </div>
  </div>

  <!-- versions list card -->
  <div class="versions-card">
    <div class="versions-card-head">Versions</div>
    <hr class="versions-divider">

    {% for version in versions %}
      <!-- Header row -->
      <div class="version-row-header">
        <div class="version-row-left">
          <strong class="version-number {% if version.is_deleted %}version-deleted{% endif %}">
            v{{ version.version_number }}
          </strong>

          {% if not version.is_deleted and version.status == "PASS" %}
            <a href="{% url 'test_model_cpu' version.id %}"
               class="version-cta version-cta-test">
              <span class="version-cta-icon">‚ñ∂</span>
              <span class="version-cta-label">Test</span>
            </a>
          {% endif %}

          {% if not version.is_deleted %}
            <a href="{% url 'model_comments' version.id %}?return_to=dashboard" 
               class="version-cta version-cta-comments" 
               title="View comments and discussion for this version">
              <span class="version-cta-icon">üí¨</span>
              <span class="version-cta-label">Comments</span>
            </a>
          {% endif %}
        </div>

        <div class="version-row-right">
          <span class="badge bg-info">{{ version.tag }}</span>

          {% if version.is_deleted %}
            <span class="badge bg-danger">Deleted</span>
          {% elif version.status == "PASS" %}
            <span class="badge bg-success">Passed</span>
            {% if version.is_active %}
              <span class="badge bg-success">Active</span>
            {% else %}
              <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          {% elif version.status == "FAIL" %}
            <span class="badge bg-danger">Failed</span>
          {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </div>
      </div>

      {% if version.log %}
        <div class="version-log-block {% if version.is_deleted %}opacity-50{% endif %}">
          <pre class="version-log-pre {% if version.status == 'PASS' %}log-success{% elif version.is_deleted %}log-deleted{% else %}log-error{% endif %}">{{ version.log }}</pre>
        </div>
      {% endif %}

      <hr class="versions-row-sep">
    {% empty %}
      <div class="versions-empty">No versions found</div>
    {% endfor %}
  </div>
</div>

<style>
.detail-shell {
  max-width: 1100px;
  background-color:#1b1d22;
  border:1px solid rgba(255,255,255,0.07);
  border-radius:16px;
  margin:0 auto;
  box-shadow:0 32px 64px rgba(0,0,0,0.8);
  color:#fff;
  padding:24px;
  font-family: system-ui,-apple-system,BlinkMacSystemFont,"Inter",Roboto,"Helvetica Neue",Arial,sans-serif;
}

/* Top bar */
.detail-top-bar {
  margin-bottom: 20px;
}

/* Back */
.detail-back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background-color: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 0.9rem;
  font-weight: 500;
  color: #fff;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;
}
.detail-back-btn:hover {
  background-color: rgba(255,255,255,0.1);
  text-decoration: none;
  color: #fff;
  transform: translateX(-2px);
}

/* Header section */
.detail-header {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.07);
}

.detail-title-section {
  flex: 1;
  min-width: 200px;
}

.detail-model-name {
  font-size: 1.4rem;
  font-weight: 600;
  color: #fff;
  line-height: 1.3;
  margin-bottom: 4px;
}

.detail-model-meta {
  color: #8f96a3;
  font-size: 0.9rem;
  line-height: 1.4;
}

.detail-action-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  flex-shrink: 0;
}

/* gray btn */
.detail-manage-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background-color: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 0.9rem;
  font-weight: 500;
  color: #fff;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;
}
.detail-manage-btn:hover {
  background-color: rgba(255,255,255,0.1);
  text-decoration: none;
  color: #fff;
}

/* blue btn */
.detail-new-version-btn {
  display: inline-flex;
  align-items: center;
  background: radial-gradient(circle at 20% 20%, #4a6bff 0%, #1d3bd1 60%);
  box-shadow: 0 4px 12px rgba(35,76,228,0.4);
  color: #fff;
  font-weight: 600;
  font-size: 0.9rem;
  padding: 10px 18px;
  border-radius: 10px;
  text-decoration: none;
  border: 0;
  cursor: pointer;
  transition: all 0.2s ease;
}
.detail-new-version-btn:hover {
  filter: brightness(1.1);
  color: #fff;
  text-decoration: none;
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(35,76,228,0.5);
}

/* versions card */
.versions-card {
  background-color:#24272d;
  border:1px solid rgba(255,255,255,0.07);
  border-radius:12px;
  box-shadow:0 24px 48px rgba(0,0,0,0.7);
  padding:20px;
}
.versions-card-head {
  font-size:0.9rem;
  font-weight:600;
  color:#fff;
  margin-bottom:8px;
}
.versions-divider {
  border:0;
  border-top:1px solid rgba(255,255,255,0.07);
  margin:0 0 16px 0;
}

/* center "No versions found" */
.versions-empty {
  text-align: center;
  color: #9ca3af;
  font-size: 0.9rem;
  padding: 24px 0 8px;
}

.version-row-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
  gap: 12px;
}

/* left = v10 + Test + Comments */
.version-row-left {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* right = tag + status badges */
.version-row-right {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.version-number {
  font-size: 0.95rem;
  color: #fff;
}

.version-deleted {
  text-decoration: line-through;
  color: #999;
}

/* slimmer Test / Comments pills */
.version-cta {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;          /* smaller pill */
  border-radius: 999px;
  font-size: 0.78rem;         /* slightly smaller text */
  font-weight: 600;
  text-decoration: none;
  border: none;
  cursor: pointer;
  color: #fff;
  box-shadow: 0 3px 8px rgba(0,0,0,0.35);
  transition:
    transform 0.15s ease,
    box-shadow 0.15s ease,
    filter 0.15s ease;
}

.version-cta-test {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

.version-cta-comments {
  background: linear-gradient(135deg, #10b981, #059669);
}

.version-cta:hover {
  filter: brightness(1.06);
  transform: translateY(-1px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.45);
  text-decoration: none;
}

.version-cta:focus-visible {
  outline: 2px solid #e5e7eb;
  outline-offset: 2px;
}

.version-cta-icon {
  font-size: 0.8rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.version-cta-label {
  line-height: 1;
}

.version-log-block {
  background-color:#000;
  border-radius:8px;
  padding:12px 16px;
  margin-bottom:16px;
  overflow-x:auto;
  box-shadow:0 16px 32px rgba(0,0,0,0.8);
}
.version-log-pre {
  white-space:pre-wrap;
  word-break:break-word;
  font-size:0.9rem;
  line-height:1.5;
  margin:0;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
}

.log-success {
  color: #4ade80;
}
.log-deleted {
  color: #6b7280;
}
.log-error {
  color: #f87171;
}

.versions-row-sep {
  border:0;
  border-top:1px solid rgba(255,255,255,0.07);
  margin:0 0 16px 0;
}
</style>


{% elif page == "add_version" %}
<div class="version-shell text-light mx-auto">

  <!-- Top bar for back button -->
  <div class="vs-top-bar">
    <a href="?page=detail&pk={{ upload.pk }}" class="vs-back-btn">
      <span>‚Üê</span>
      <span>Back</span>
    </a>
  </div>

  <div class="vs-header">
    <div class="vs-title">Upload Model Version</div>
    <div class="vs-subtitle">Attach model artifacts and describe this version before validation.</div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  {% if form.errors %}
    <div class="alert alert-danger">
      <ul class="mb-0">
        {% for field, errors in form.errors.items %}
          <li><strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="uploadForm" class="vs-form">
    {% csrf_token %}

    <!-- Files -->
    <section class="vs-card">
      <div class="vs-section-title">Model Files</div>
      <div class="vs-grid">

        <div class="vs-field">
          <label class="vs-label">
            Model (.pt file) <span class="vs-required">*</span>
          </label>
          <div class="vs-file-box">
            <div class="vs-file-desc">
              <div class="vs-file-heading">Primary model weights</div>
              <div class="vs-file-hint">PyTorch checkpoint / state_dict</div>
            </div>
            {{ form.model_file|add_class:"d-none"|attr:"id:id_model_file" }}
            <button type="button" class="vs-file-btn" onclick="document.getElementById('id_model_file').click();">
              + Add .pt
            </button>
          </div>
          <div id="modelFileName" class="vs-file-name">No file chosen</div>
        </div>

        <div class="vs-field">
          <label class="vs-label">
            Inference Script (.py) <span class="vs-required">*</span>
          </label>
          <div class="vs-file-box">
            <div class="vs-file-desc">
              <div class="vs-file-heading">Prediction entry point</div>
              <div class="vs-file-hint">Should expose a callable for inference</div>
            </div>
            {{ form.predict_file|add_class:"d-none"|attr:"id:id_predict_file" }}
            <button type="button" class="vs-file-btn" onclick="document.getElementById('id_predict_file').click();">
              + Add .py
            </button>
          </div>
          <div id="predictFileName" class="vs-file-name">No file chosen</div>
        </div>

        <div class="vs-field">
          <label class="vs-label">
            Schema (schema.json) <span class="vs-required">*</span>
          </label>
          <div class="vs-file-box">
            <div class="vs-file-desc">
              <div class="vs-file-heading">Input / output contract</div>
              <div class="vs-file-hint">JSON describing request & response fields</div>
            </div>
            {{ form.schema_file|add_class:"d-none"|attr:"id:id_schema_file" }}
            <button type="button" class="vs-file-btn" onclick="document.getElementById('id_schema_file').click();">
              + Add .json
            </button>
          </div>
          <div id="schemaFileName" class="vs-file-name">No file chosen</div>
        </div>

      </div>
    </section>

    <!-- Metadata -->
    <section class="vs-card">
      <div class="vs-section-title">Version Details</div>

      <div class="vs-metadata-grid">
        <div class="vs-field-full">
          <label class="vs-label">
            Model Information <span class="vs-required">*</span>
          </label>
          <div class="vs-hint">
            Summarize what this version does, what's changed, and any warnings.
          </div>

          {# Use placeholder from VersionForm widget #}
          {{ form.information|add_class:"form-control vs-textarea" }}

          <!-- Generate with AI row -->
          <div class="vs-ai-row">
            <button type="button" class="vs-ai-btn" id="generateWithAIButton">
              <span class="vs-ai-icon">‚ú®</span>
              <span>Generate with AI</span>
            </button>
            <div id="aiStatusText" class="vs-ai-status">
              <!-- status text will appear here -->
            </div>
          </div>
        </div>

        <div class="vs-field-half">
          <label class="vs-label">
            Tag <span class="vs-required">*</span>
          </label>
          {{ form.tag|add_class:"form-control vs-input" }}
          <div class="vs-hint-inline">Example: v2-beta, prod, hotfix-3</div>
        </div>

        <div class="vs-field-half">
          <label class="vs-label">
            Category
          </label>
          {{ form.category|add_class:"form-select vs-input" }}
          <div class="vs-hint-inline">Used for grouping internally</div>
        </div>
      </div>
    </section>

    <div class="vs-footer">
      <button type="submit" class="vs-submit-btn">
        <span class="vs-submit-label">Upload &amp; Validate</span>
      </button>
    </div>
  </form>
</div>

<style>
.version-shell {
  max-width: 900px;
  background-color: #1b1d22;
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 16px;
  padding: 24px 24px 32px;
  box-shadow: 0 32px 64px rgba(0,0,0,0.8);
  font-family: system-ui,-apple-system,BlinkMacSystemFont,"Inter",Roboto,"Helvetica Neue",Arial,sans-serif;
  color:#fff;
}

/* Top bar for back button */
.vs-top-bar {
  margin-bottom: 20px;
}

/* Back button - gray */
.vs-back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background-color: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 0.9rem;
  font-weight: 500;
  color: #fff;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;
}
.vs-back-btn:hover {
  background-color: rgba(255,255,255,0.1);
  text-decoration: none;
  color: #fff;
}

/* header for add_version */
.vs-header {
  margin-bottom:24px;
}
.vs-title {
  color:#fff;
  font-size:1.2rem;
  font-weight:600;
  line-height:1.4;
  margin-bottom: 4px;
}
.vs-subtitle {
  color:#8f96a3;
  font-size:0.9rem;
  line-height:1.4;
}

/* cards */
.vs-card {
  background-color:#24272d;
  border:1px solid rgba(255,255,255,0.07);
  border-radius:12px;
  padding:20px;
  margin-bottom:24px;
  box-shadow:0 24px 48px rgba(0,0,0,0.7);
}
.vs-section-title {
  color:#fff;
  font-size:0.9rem;
  font-weight:600;
  margin-bottom:16px;
  letter-spacing:0.02em;
  border-bottom:1px solid rgba(255,255,255,0.07);
  padding-bottom:8px;
}

/* responsive grid for file pickers */
.vs-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(min(260px,100%),1fr));
  gap:20px;
}

/* Metadata grid */
.vs-metadata-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

.vs-field-full {
  grid-column: 1 / -1;
  display: flex;
  flex-direction: column;
  margin-bottom: 8px;
}

.vs-field-half {
  display: flex;
  flex-direction: column;
  margin-bottom: 8px;
}

.vs-field {
  display:flex;
  flex-direction:column;
  color:#fff;
  margin-bottom: 8px;
}

.vs-label {
  font-size:0.85rem;
  font-weight:500;
  color:#fff;
  display:block;
  margin-bottom:6px;
  line-height:1.3;
}
.vs-required {
  color:#ff6b6b;
  font-weight:600;
  margin-left:4px;
}
.vs-hint,
.vs-hint-inline {
  font-size:0.8rem;
  line-height:1.4;
  color:#9ca3af;
}
.vs-hint { margin-bottom:8px; }
.vs-hint-inline { margin-top:6px; }

/* file box */
.vs-file-box {
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  background-color:#2d3036;
  border:1px solid rgba(255,255,255,0.07);
  border-radius:10px;
  padding:16px;
  gap:16px;
}
.vs-file-desc { flex:1; min-width:0; }
.vs-file-heading {
  color:#fff;
  font-size:0.9rem;
  font-weight:500;
  line-height:1.4;
}
.vs-file-hint {
  font-size:0.8rem;
  line-height:1.4;
  color:#9ca3af;
  margin-top:2px;
}
.vs-file-btn {
  white-space:nowrap;
  border:1px solid rgba(255,255,255,0.3);
  background:rgba(255,255,255,0.08);
  color:#fff;
  font-size:0.8rem;
  font-weight:500;
  padding:8px 12px;
  line-height:1.2;
  border-radius:8px;
  min-width:80px;
  cursor:pointer;
  transition: all 0.2s ease;
}
.vs-file-btn:hover {
  background:rgba(255,255,255,0.15);
  border-color:rgba(255,255,255,0.4);
}
.vs-file-name {
  font-size:0.8rem;
  line-height:1.4;
  color:#9ca3af;
  margin-top:6px;
  word-break:break-all;
  min-height:1.4em;
}

/* inputs */
.vs-input,
.vs-textarea {
  background-color:#1b1d22 !important;
  color:#fff !important;
  border:1px solid rgba(255,255,255,0.18) !important;
  font-size:0.9rem;
  border-radius:8px;
  line-height:1.4;
  padding:10px 12px;
}

/* make placeholder visible */
.vs-input::placeholder,
.vs-textarea::placeholder {
  color: #9ca3af;
  opacity: 1;
}

.vs-input:focus,
.vs-textarea:focus {
  outline:2px solid rgba(80,130,255,0.6);
  outline-offset:0;
  box-shadow:0 0 0 4px rgba(80,130,255,0.15);
  border-color:rgba(80,130,255,0.8) !important;
}

/* Generate with AI row */
.vs-ai-row {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 6px;
}

.vs-ai-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  border-radius: 999px;
  border: 1px solid rgba(129,140,248,0.9);
  background: radial-gradient(circle at 10% 0%, #1e293b 0%, #020617 65%);
  box-shadow:
    0 0 0 1px rgba(15,23,42,0.9),
    0 14px 30px rgba(15,23,42,0.85);
  font-size: 0.85rem;
  font-weight: 600;
  color: #e5e7eb;
  cursor: pointer;
  transition:
    background-color 0.15s ease,
    border-color 0.15s ease,
    box-shadow 0.15s ease,
    transform 0.15s ease;
}
.vs-ai-btn:hover:not(:disabled) {
  border-color: rgba(196,181,253,1);
  box-shadow:
    0 0 0 1px rgba(129,140,248,0.7),
    0 16px 40px rgba(15,23,42,0.95);
  transform: translateY(-1px);
}
.vs-ai-btn:disabled {
  opacity: 0.6;
  cursor: wait;
}

.vs-ai-icon {
  width: 18px;
  height: 18px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  background: radial-gradient(circle at 30% 0%, #fbbf24 0%, #f97316 60%);
  box-shadow:
    0 0 0 1px rgba(251,191,36,0.9),
    0 0 12px rgba(245,158,11,0.9);
}

.vs-ai-status {
  font-size: 0.78rem;
  color: #9ca3af;
  min-height: 1.2em;
}

/* footer */
.vs-footer { margin-top:24px; }
.vs-submit-btn {
  appearance:none;
  border:0;
  border-radius:10px;
  width:100%;
  background:radial-gradient(circle at 20% 20%, #4a6bff 0%, #1d3bd1 60%);
  box-shadow:0 24px 48px rgba(35,76,228,0.4);
  color:#fff;
  font-weight:600;
  font-size:1rem;
  line-height:1.3;
  padding:14px 16px;
  text-align:center;
  cursor:pointer;
  transition: all 0.2s ease;
}
.vs-submit-btn:disabled {
  opacity:.6;
  cursor:wait;
}
.vs-submit-btn:hover:not(:disabled){
  filter:brightness(1.07);
  transform: translateY(-1px);
}
.vs-submit-label {
  display:inline-flex;
  align-items:center;
  gap:.5rem;
}

@media (max-width: 600px) {
  .vs-metadata-grid {
    grid-template-columns: 1fr;
  }
  .vs-field-half {
    grid-column: 1 / -1;
  }
}
</style>

<script>
// file name display on change
document.getElementById('id_model_file').addEventListener('change', function(e) {
  const fileName = e.target.files[0] ? `‚úî ${e.target.files[0].name}` : "No file chosen";
  document.getElementById('modelFileName').innerText = fileName;
});
document.getElementById('id_predict_file').addEventListener('change', function(e) {
  const fileName = e.target.files[0] ? `‚úî ${e.target.files[0].name}` : "No file chosen";
  document.getElementById('predictFileName').innerText = fileName;
});
document.getElementById('id_schema_file').addEventListener('change', function(e) {
  const fileName = e.target.files[0] ? `‚úî ${e.target.files[0].name}` : "No file chosen";
  document.getElementById('schemaFileName').innerText = fileName;
});

// validation before submit
document.getElementById('uploadForm').addEventListener('submit', function(e) {
  const modelFile = document.getElementById('id_model_file');
  const predictFile = document.getElementById('id_predict_file');
  const schemaFile = document.getElementById('id_schema_file');
  const tagInput = document.querySelector('input[name="tag"]');
  const infoInput = document.querySelector('textarea[name="information"]');

  const missing = [];
  if (!modelFile.files.length) missing.push('‚Ä¢ Model file (.pt)');
  if (!predictFile.files.length) missing.push('‚Ä¢ Predict file (.py)');
  if (!schemaFile.files.length) missing.push('‚Ä¢ Schema file (.json)');
  if (!tagInput.value.trim()) missing.push('‚Ä¢ Tag');
  if (!infoInput.value.trim()) missing.push('‚Ä¢ Model Information');

  if (missing.length > 0) {
    e.preventDefault();
    alert(
      'Missing required fields:\n\n' +
      missing.join('\n') +
      '\n\nPlease fill all required fields before submitting.'
    );
    return false;
  }

  if (modelFile.files[0] && !modelFile.files[0].name.endsWith('.pt')) {
    e.preventDefault();
    alert('Model file must be a .pt file');
    return false;
  }
  if (predictFile.files[0] && !predictFile.files[0].name.endsWith('.py')) {
    e.preventDefault();
    alert('Predict file must be a .py file');
    return false;
  }
  if (schemaFile.files[0] && !schemaFile.files[0].name.endsWith('.json')) {
    e.preventDefault();
    alert('Schema file must be a .json file');
    return false;
  }

  const submitBtn = this.querySelector('.vs-submit-btn');
  submitBtn.disabled = true;
  submitBtn.innerHTML =
    '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>' +
    '<span> Uploading‚Ä¶ </span>';
});

// Reuse getCookie from list-page script if available;
// if not, define a fallback here.
if (typeof getCookie === "undefined") {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
}

/* --------- Generate with AI logic --------- */
const aiBtn       = document.getElementById("generateWithAIButton");
const aiStatus    = document.getElementById("aiStatusText");
const infoField   = document.querySelector('textarea[name="information"]');
const uploadForm  = document.getElementById("uploadForm");

if (aiBtn && aiStatus && infoField && uploadForm) {
  aiBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    const modelInput   = document.getElementById("id_model_file");
    const predictInput = document.getElementById("id_predict_file");
    const schemaInput  = document.getElementById("id_schema_file");

    if (!modelInput.files.length ||
        !predictInput.files.length ||
        !schemaInput.files.length) {
      aiStatus.textContent = "Please select a .pt, .py, and .json file first.";
      return;
    }

    aiBtn.disabled = true;
    aiStatus.textContent = "‚ú® Generating description with AI...";

    // Build FormData from the whole form so it includes the three files
    const formData = new FormData(uploadForm);

    try {
      const resp = await fetch("{% url 'generate_model_info' %}", {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: formData,
      });

      const data = await resp.json();

      if (resp.ok && data.description) {
        infoField.value = data.description;
        aiStatus.textContent =
          "‚úÖ Description generated. You can edit it before uploading.";
      } else {
        aiStatus.textContent =
          data.error ||
          "Could not generate description. Please try again or write it manually.";
      }
    } catch (err) {
      console.error("Generate with AI error:", err);
      aiStatus.textContent =
        "Network or server issue while generating description. Please try again or write it manually.";
    } finally {
      aiBtn.disabled = false;
    }
  });
}
</script>
{% endif %}

{% endblock %}