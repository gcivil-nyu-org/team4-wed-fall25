commands:
  01_fix_tmp_permissions:
    command: "chmod 1777 /tmp"

container_commands:
  01_copy_nginx_static_config:
    command: "cp /etc/nginx/conf.d/app/*.conf /etc/nginx/conf.d/elasticbeanstalk/ 2>/dev/null || true"
  02_fix_db_ownership:
    command: "[ -f /tmp/db.sqlite3 ] && chown webapp:webapp /tmp/db.sqlite3 || true"
  03_fix_db_permissions:
    command: "[ -f /tmp/db.sqlite3 ] && chmod 666 /tmp/db.sqlite3 || true"
  04_migrate:
    command: "sudo -u webapp bash -c 'cd /var/app/current && source /var/app/venv/*/bin/activate && python manage.py migrate --noinput'"
    leader_only: true
  05_collectstatic:
    command: "source /var/app/venv/*/bin/activate && python manage.py collectstatic --noinput"
    leader_only: true
  06_reload_nginx:
    command: "nginx -t && systemctl reload nginx"
  07_fix_db_ownership_after:
    command: "[ -f /tmp/db.sqlite3 ] && chown webapp:webapp /tmp/db.sqlite3 || true"
  08_fix_db_permissions_after:
    command: "[ -f /tmp/db.sqlite3 ] && chmod 666 /tmp/db.sqlite3 || true"