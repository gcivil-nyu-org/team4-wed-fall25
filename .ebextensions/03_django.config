commands:
  01_fix_tmp_permissions:
    command: "chmod 1777 /tmp"

container_commands:
  01_create_staticfiles_dir:
    command: "mkdir -p /var/app/current/staticfiles && chown webapp:webapp /var/app/current/staticfiles && chmod 755 /var/app/current/staticfiles"
  02_fix_db_ownership:
    command: "[ -f /tmp/db.sqlite3 ] && chown webapp:webapp /tmp/db.sqlite3 || true"
  03_fix_db_permissions:
    command: "[ -f /tmp/db.sqlite3 ] && chmod 666 /tmp/db.sqlite3 || true"
  04_migrate:
    command: "sudo -u webapp bash -c 'cd /var/app/current && source /var/app/venv/*/bin/activate && python manage.py migrate --noinput'"
    leader_only: true
  05_collectstatic:
    command: "sudo -u webapp bash -c 'cd /var/app/current && source /var/app/venv/*/bin/activate && python manage.py collectstatic --noinput --clear'"
    leader_only: true
  06_set_static_permissions:
    command: "chmod -R 755 /var/app/current/staticfiles && chown -R webapp:webapp /var/app/current/staticfiles"
  07_set_media_permissions:
    command: "mkdir -p /var/app/current/media && chmod -R 755 /var/app/current/media && chown -R webapp:webapp /var/app/current/media"
  08_fix_db_ownership_after:
    command: "[ -f /tmp/db.sqlite3 ] && chown webapp:webapp /tmp/db.sqlite3 || true"
  09_fix_db_permissions_after:
    command: "[ -f /tmp/db.sqlite3 ] && chmod 666 /tmp/db.sqlite3 || true"